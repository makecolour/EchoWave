<!DOCTYPE html>
<html lang="en" ng-app="echowaveApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- Bootstrap CSS -->
    <style><%- bootstrapCSS %></style>
    <!-- Toastr CSS -->
    <style><%- toastrCSS %></style>
</head>
<body ng-controller="ChatController" class="bg-primary min-vh-100 d-flex align-items-center justify-content-center p-3">
    <div class="container" style="max-width: 800px;">
        <div class="card shadow-lg" style="height: 85vh;">
            <div class="card-body d-flex flex-column p-0">
                <!-- Header -->
                <div class="bg-primary text-white p-4 rounded-top">
                    <h2 class="mb-2 fw-semibold">
                        üí¨ EchoWave Chat
                    </h2>
                    <div class="small">
                        <span class="badge rounded-pill me-1" ng-class="{'bg-success': isConnected, 'bg-danger': !isConnected}">
                            {{isConnected ? '‚óè' : '‚óã'}}
                        </span>
                        <strong>Device:</strong> {{deviceName || 'Connecting...'}} 
                        <small ng-if="deviceId" class="text-white-50">({{deviceId}})</small>
                    </div>
                    <span class="badge mt-2" ng-class="{'bg-success': isConnected, 'bg-danger': !isConnected}">
                        {{connectionStatus}}
                    </span>
                </div>

                <!-- Messages -->
                <div class="flex-grow-1 overflow-auto p-4 bg-light" id="messagesContainer">
                    <div ng-if="messages.length === 0" class="text-center text-muted my-5">
                        <h5>No messages yet</h5>
                        <p>Start the conversation!</p>
                    </div>
                    
                    <div ng-repeat="msg in messages track by $index" class="mb-3">
                        <div ng-if="msg.senderDeviceId !== deviceId" class="text-start">
                            <div class="d-inline-block">
                                <div class="badge bg-primary text-start mb-1 small">
                                    {{msg.senderName || msg.senderDeviceId}}
                                </div>
                                <div class="card border-0 shadow-sm" style="max-width: 70%;">
                                    <div class="card-body p-3">
                                        <p class="mb-1">{{msg.message}}</p>
                                        <small class="text-muted">{{msg.timestamp | date:'short'}}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div ng-if="msg.senderDeviceId === deviceId" class="text-end">
                            <div class="d-inline-block">
                                <div class="card bg-primary text-white border-0 shadow-sm" style="max-width: 70%;">
                                    <div class="card-body p-3">
                                        <p class="mb-1">{{msg.message}}</p>
                                        <small class="opacity-75">{{msg.timestamp | date:'short'}}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-white border-top">
                    <form ng-submit="sendMessage()" class="input-group input-group-lg">
                        <input type="text" 
                               class="form-control" 
                               ng-model="newMessage" 
                               placeholder="Type a message..." 
                               ng-disabled="!isConnected"
                               autocomplete="off">
                        <button type="submit" 
                                class="btn btn-primary" 
                                ng-disabled="!isConnected || !newMessage.trim()">
                            <strong>Send</strong>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script><%- jquery %></script>
    <script><%- bootstrapJS %></script>
    <script><%- angular %></script>
    <script><%- toastrJS %></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // Configure Toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000"
        };

        // AngularJS App
        var app = angular.module('echowaveApp', []);

        app.controller('ChatController', ['$scope', '$timeout', function($scope, $timeout) {
            $scope.messages = [];
            $scope.newMessage = '';
            $scope.deviceId = localStorage.getItem('deviceId');
            $scope.deviceName = localStorage.getItem('deviceName');
            $scope.isConnected = false;
            $scope.connectionStatus = 'Connecting...';
            
            var socket = io({
                transports: ['websocket', 'polling']
            });

            // Socket connection
            socket.on('connect', function() {
                console.log('Connected to server');
                $scope.$apply(function() {
                    $scope.connectionStatus = 'Registering...';
                });
                
                // Register device
                socket.emit('register', { 
                    deviceId: $scope.deviceId, 
                    deviceName: $scope.deviceName 
                }, function(response) {
                    $scope.$apply(function() {
                        if (response.success) {
                            $scope.deviceId = response.deviceId;
                            $scope.deviceName = response.deviceName;
                            $scope.isConnected = true;
                            $scope.connectionStatus = 'Connected';
                            
                            // Save to localStorage
                            localStorage.setItem('deviceId', $scope.deviceId);
                            localStorage.setItem('deviceName', $scope.deviceName);
                            
                            // Load history
                            if (response.history && response.history.length > 0) {
                                $scope.messages = response.history;
                                scrollToBottom();
                            }
                            
                            toastr.success('Connected as ' + $scope.deviceName, 'Connected');
                        } else {
                            $scope.connectionStatus = 'Registration Failed';
                            toastr.error(response.error, 'Registration Failed');
                        }
                    });
                });
            });

            socket.on('disconnect', function() {
                $scope.$apply(function() {
                    $scope.isConnected = false;
                    $scope.connectionStatus = 'Disconnected';
                });
                toastr.warning('Disconnected from server', 'Connection Lost');
            });

            socket.on('new_message', function(data) {
                $scope.$apply(function() {
                    $scope.messages.push(data);
                    scrollToBottom();
                    
                    // Show notification for received messages
                    if (data.senderDeviceId !== $scope.deviceId) {
                        toastr.info(data.message, data.senderName || 'New Message');
                    }
                });
            });

            socket.on('user_connected', function(data) {
                toastr.info(data.deviceName + ' joined the chat', 'User Connected');
            });

            socket.on('user_disconnected', function(data) {
                toastr.warning(data.deviceName + ' left the chat', 'User Disconnected');
            });

            // Send message
            $scope.sendMessage = function() {
                if (!$scope.newMessage.trim() || !$scope.isConnected) return;
                
                var message = $scope.newMessage.trim();
                
                socket.emit('send_message', {
                    message: message,
                    receiverDeviceId: null // broadcast
                }, function(response) {
                    if (!response.success) {
                        toastr.error(response.error, 'Failed to send');
                    }
                });
                
                $scope.newMessage = '';
            };

            // Scroll to bottom helper
            function scrollToBottom() {
                $timeout(function() {
                    var container = document.getElementById('messagesContainer');
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }]);
    </script>
</body>
</html>
